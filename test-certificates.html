<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Certificate System - Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .test-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .test-section h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.ready {
            background: #d4edda;
            color: #155724;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .svg-preview {
            margin-top: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .card h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .card p {
            color: #666;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }

        .instructions li {
            margin: 5px 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéì NFT Certificate System - Test Suite</h1>
            <p>Comprehensive testing tool for Web3Versity NFT certificates with SVG generation, HFS storage, and blockchain verification</p>
        </div>

        <!-- Configuration -->
        <div class="test-section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="form-group">
                <label>Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
            </div>
            <div class="form-group">
                <label>Supabase Anon Key</label>
                <input type="text" id="supabaseKey" placeholder="eyJ...">
            </div>
            <div class="form-group">
                <label>Test User ID</label>
                <input type="text" id="userId" placeholder="uuid-format">
            </div>
            <div class="form-group">
                <label>Test Course ID</label>
                <input type="text" id="courseId" placeholder="uuid-format">
            </div>
            <button onclick="saveConfig()">üíæ Save Configuration</button>
            <span id="configStatus"></span>
        </div>

        <!-- Test 1: Mint Certificate -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Mint Certificate</h2>
            <div class="instructions">
                <strong>Prerequisites:</strong>
                <ol>
                    <li>Database migration must be complete</li>
                    <li>HMAC secret must be set in Supabase Edge Function secrets</li>
                    <li>Edge Function must be deployed</li>
                    <li>User must have completed the course (100%)</li>
                </ol>
            </div>
            <button onclick="mintCertificate()" id="mintBtn">üé® Mint Certificate</button>
            <div id="mintResult"></div>
        </div>

        <!-- Test 2: Verify Certificate -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Verify Certificate</h2>
            <div class="form-group">
                <label>Certificate Number</label>
                <input type="text" id="certNumber" placeholder="W3V-2025-00001">
            </div>
            <button onclick="verifyCertificate()" id="verifyBtn">üîç Verify Certificate</button>
            <div id="verifyResult"></div>
        </div>

        <!-- Test 3: Fetch SVG from HFS -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Fetch SVG from HFS</h2>
            <div class="form-group">
                <label>HFS File ID</label>
                <input type="text" id="hfsFileId" placeholder="0.0.12345">
            </div>
            <button onclick="fetchSVG()" id="fetchBtn">üì• Fetch SVG</button>
            <button onclick="downloadSVG()" id="downloadBtn" disabled>üíæ Download SVG</button>
            <div id="fetchResult"></div>
            <div id="svgPreview" class="svg-preview" style="display:none;"></div>
        </div>

        <!-- Test 4: Fetch Metadata from HFS -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Fetch Metadata from HFS</h2>
            <div class="form-group">
                <label>Metadata HFS File ID</label>
                <input type="text" id="metadataFileId" placeholder="0.0.67890">
            </div>
            <button onclick="fetchMetadata()" id="metadataBtn">üìÑ Fetch Metadata</button>
            <div id="metadataResult"></div>
        </div>

        <!-- Test 5: Get User Certificates -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Get User Certificates</h2>
            <button onclick="getUserCertificates()" id="getUserCertsBtn">üìã Get My Certificates</button>
            <div id="userCertsResult"></div>
        </div>

        <!-- Test 6: Mirror Node - NFT Info -->
        <div class="test-section">
            <h2>6Ô∏è‚É£ Query Mirror Node (NFT Info)</h2>
            <div class="form-group">
                <label>Token ID</label>
                <input type="text" id="tokenId" placeholder="0.0.123456">
            </div>
            <div class="form-group">
                <label>Serial Number</label>
                <input type="number" id="serialNumber" placeholder="1">
            </div>
            <button onclick="getMirrorNodeNFT()" id="mirrorBtn">üîó Query Mirror Node</button>
            <div id="mirrorResult"></div>
        </div>

        <!-- Test 7: Generate HMAC Signature -->
        <div class="test-section">
            <h2>7Ô∏è‚É£ Generate HMAC Signature (Client-Side Test)</h2>
            <div class="instructions">
                <strong>Note:</strong> This tests the HMAC signature algorithm using Web Crypto API (same as Edge Function)
            </div>
            <div class="form-group">
                <label>Certificate Number</label>
                <input type="text" id="sigCertNum" placeholder="W3V-2025-00001">
            </div>
            <div class="form-group">
                <label>User Name</label>
                <input type="text" id="sigUserName" placeholder="Alice">
            </div>
            <div class="form-group">
                <label>Course Name</label>
                <input type="text" id="sigCourseName" placeholder="Intro to Web3">
            </div>
            <div class="form-group">
                <label>Completion Date</label>
                <input type="text" id="sigDate" placeholder="2025-10-21">
            </div>
            <div class="form-group">
                <label>User Hedera Account</label>
                <input type="text" id="sigAccount" placeholder="0.0.7045900">
            </div>
            <div class="form-group">
                <label>HMAC Secret (64-char hex)</label>
                <input type="text" id="hmacSecret" placeholder="a1b2c3d4...">
            </div>
            <button onclick="generateSignature()" id="sigBtn">üîê Generate Signature</button>
            <div id="sigResult"></div>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            supabaseUrl: '',
            supabaseKey: '',
            userId: '',
            courseId: ''
        };

        let currentSVG = null;

        // Load config from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('certTestConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('supabaseUrl').value = config.supabaseUrl || '';
                document.getElementById('supabaseKey').value = config.supabaseKey || '';
                document.getElementById('userId').value = config.userId || '';
                document.getElementById('courseId').value = config.courseId || '';
                showStatus('configStatus', '‚úÖ Configuration loaded', 'ready');
            }
        });

        function saveConfig() {
            config = {
                supabaseUrl: document.getElementById('supabaseUrl').value,
                supabaseKey: document.getElementById('supabaseKey').value,
                userId: document.getElementById('userId').value,
                courseId: document.getElementById('courseId').value
            };
            localStorage.setItem('certTestConfig', JSON.stringify(config));
            showStatus('configStatus', '‚úÖ Configuration saved!', 'ready');
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        function showResult(elementId, data, type = 'info') {
            const el = document.getElementById(elementId);
            const formatted = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            el.innerHTML = `<div class="result ${type}">${formatted}</div>`;
        }

        function showLoading(buttonId, loading = true) {
            const btn = document.getElementById(buttonId);
            btn.disabled = loading;
            if (loading) {
                btn.innerHTML += '<span class="loading"></span>';
            }
        }

        // Test 1: Mint Certificate
        async function mintCertificate() {
            if (!config.supabaseUrl || !config.userId || !config.courseId) {
                showResult('mintResult', 'Error: Please configure all required fields', 'error');
                return;
            }

            showLoading('mintBtn', true);
            showResult('mintResult', 'Minting certificate... This may take 10-15 seconds.', 'info');

            try {
                const response = await fetch(
                    `${config.supabaseUrl}/functions/v1/mint-certificate`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.supabaseKey}`,
                            'apikey': config.supabaseKey
                        },
                        body: JSON.stringify({
                            userId: config.userId,
                            courseId: config.courseId
                        })
                    }
                );

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult('mintResult', data, 'success');
                    // Auto-populate verify fields
                    if (data.certificate?.certificateNumber) {
                        document.getElementById('certNumber').value = data.certificate.certificateNumber;
                    }
                    if (data.certificate?.imageHfsFileId) {
                        document.getElementById('hfsFileId').value = data.certificate.imageHfsFileId;
                    }
                    if (data.certificate?.metadataHfsFileId) {
                        document.getElementById('metadataFileId').value = data.certificate.metadataHfsFileId;
                    }
                    if (data.certificate?.tokenId) {
                        document.getElementById('tokenId').value = data.certificate.tokenId;
                    }
                    if (data.certificate?.serialNumber) {
                        document.getElementById('serialNumber').value = data.certificate.serialNumber;
                    }
                } else {
                    showResult('mintResult', data, 'error');
                }
            } catch (error) {
                showResult('mintResult', `Network Error: ${error.message}`, 'error');
            } finally {
                showLoading('mintBtn', false);
            }
        }

        // Test 2: Verify Certificate
        async function verifyCertificate() {
            const certNumber = document.getElementById('certNumber').value;
            if (!certNumber) {
                showResult('verifyResult', 'Error: Please enter certificate number', 'error');
                return;
            }

            if (!config.supabaseUrl) {
                showResult('verifyResult', 'Error: Please configure Supabase URL', 'error');
                return;
            }

            showLoading('verifyBtn', true);
            showResult('verifyResult', 'Verifying certificate...', 'info');

            try {
                const response = await fetch(
                    `${config.supabaseUrl}/functions/v1/verify-certificate`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': config.supabaseKey
                        },
                        body: JSON.stringify({ certificateNumber: certNumber })
                    }
                );

                const data = await response.json();

                if (data.valid) {
                    showResult('verifyResult', data, 'success');
                    // Auto-populate HFS fields
                    if (data.certificate?.imageHfsFileId) {
                        document.getElementById('hfsFileId').value = data.certificate.imageHfsFileId;
                    }
                    if (data.certificate?.metadataHfsFileId) {
                        document.getElementById('metadataFileId').value = data.certificate.metadataHfsFileId;
                    }
                } else {
                    showResult('verifyResult', data, 'error');
                }
            } catch (error) {
                showResult('verifyResult', `Network Error: ${error.message}`, 'error');
            } finally {
                showLoading('verifyBtn', false);
            }
        }

        // Test 3: Fetch SVG from HFS
        async function fetchSVG() {
            const fileId = document.getElementById('hfsFileId').value;
            if (!fileId) {
                showResult('fetchResult', 'Error: Please enter HFS file ID', 'error');
                return;
            }

            showLoading('fetchBtn', true);
            showResult('fetchResult', 'Fetching SVG from Hedera Mirror Node...', 'info');

            try {
                const response = await fetch(
                    `https://testnet.mirrornode.hedera.com/api/v1/files/${fileId}`
                );

                const data = await response.json();

                if (response.ok && data.file_data) {
                    // Decode base64
                    const svg = atob(data.file_data);
                    currentSVG = svg;

                    showResult('fetchResult', `‚úÖ SVG fetched successfully! Size: ${svg.length} bytes`, 'success');

                    // Show preview
                    const preview = document.getElementById('svgPreview');
                    preview.innerHTML = svg;
                    preview.style.display = 'block';

                    document.getElementById('downloadBtn').disabled = false;
                } else {
                    showResult('fetchResult', data, 'error');
                }
            } catch (error) {
                showResult('fetchResult', `Network Error: ${error.message}`, 'error');
            } finally {
                showLoading('fetchBtn', false);
            }
        }

        function downloadSVG() {
            if (!currentSVG) return;

            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `certificate-${document.getElementById('hfsFileId').value}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Test 4: Fetch Metadata
        async function fetchMetadata() {
            const fileId = document.getElementById('metadataFileId').value;
            if (!fileId) {
                showResult('metadataResult', 'Error: Please enter metadata HFS file ID', 'error');
                return;
            }

            showLoading('metadataBtn', true);
            showResult('metadataResult', 'Fetching metadata from Hedera Mirror Node...', 'info');

            try {
                const response = await fetch(
                    `https://testnet.mirrornode.hedera.com/api/v1/files/${fileId}`
                );

                const data = await response.json();

                if (response.ok && data.file_data) {
                    // Decode base64
                    const metadata = JSON.parse(atob(data.file_data));
                    showResult('metadataResult', metadata, 'success');
                } else {
                    showResult('metadataResult', data, 'error');
                }
            } catch (error) {
                showResult('metadataResult', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('metadataBtn', false);
            }
        }

        // Test 5: Get User Certificates
        async function getUserCertificates() {
            if (!config.supabaseUrl || !config.userId) {
                showResult('userCertsResult', 'Error: Please configure Supabase URL and User ID', 'error');
                return;
            }

            showLoading('getUserCertsBtn', true);
            showResult('userCertsResult', 'Fetching user certificates...', 'info');

            try {
                // Using Supabase REST API directly
                const response = await fetch(
                    `${config.supabaseUrl}/rest/v1/nft_certificates?user_id=eq.${config.userId}&order=minted_at.desc`,
                    {
                        headers: {
                            'apikey': config.supabaseKey,
                            'Authorization': `Bearer ${config.supabaseKey}`
                        }
                    }
                );

                const data = await response.json();
                showResult('userCertsResult', data, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('userCertsResult', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('getUserCertsBtn', false);
            }
        }

        // Test 6: Mirror Node NFT Query
        async function getMirrorNodeNFT() {
            const tokenId = document.getElementById('tokenId').value;
            const serial = document.getElementById('serialNumber').value;

            if (!tokenId || !serial) {
                showResult('mirrorResult', 'Error: Please enter token ID and serial number', 'error');
                return;
            }

            showLoading('mirrorBtn', true);
            showResult('mirrorResult', 'Querying Hedera Mirror Node...', 'info');

            try {
                const response = await fetch(
                    `https://testnet.mirrornode.hedera.com/api/v1/tokens/${tokenId}/nfts/${serial}`
                );

                const data = await response.json();

                if (response.ok) {
                    // Decode metadata if present
                    if (data.metadata) {
                        try {
                            const metadataJson = atob(data.metadata);
                            data.metadata_decoded = JSON.parse(metadataJson);
                        } catch (e) {
                            data.metadata_decoded = 'Could not decode metadata';
                        }
                    }
                    showResult('mirrorResult', data, 'success');
                } else {
                    showResult('mirrorResult', data, 'error');
                }
            } catch (error) {
                showResult('mirrorResult', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('mirrorBtn', false);
            }
        }

        // Test 7: Generate HMAC Signature
        async function generateSignature() {
            const certNum = document.getElementById('sigCertNum').value;
            const userName = document.getElementById('sigUserName').value;
            const courseName = document.getElementById('sigCourseName').value;
            const date = document.getElementById('sigDate').value;
            const account = document.getElementById('sigAccount').value;
            const secret = document.getElementById('hmacSecret').value;

            if (!certNum || !userName || !courseName || !date || !account || !secret) {
                showResult('sigResult', 'Error: Please fill all fields', 'error');
                return;
            }

            showLoading('sigBtn', true);

            try {
                // Create canonical string
                const canonical = [certNum, userName, courseName, date, account].join('|');

                // Convert secret to key material
                const encoder = new TextEncoder();
                const keyMaterial = encoder.encode(secret);
                const data = encoder.encode(canonical);

                // Import key for HMAC
                const key = await crypto.subtle.importKey(
                    'raw',
                    keyMaterial,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                // Generate HMAC-SHA256
                const signature = await crypto.subtle.sign('HMAC', key, data);

                // Convert to hex string
                const hashArray = Array.from(new Uint8Array(signature));
                const hex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                const result = {
                    canonical_string: canonical,
                    signature: hex,
                    length: hex.length,
                    note: 'This signature should match the platform_signature in the certificate metadata'
                };

                showResult('sigResult', result, 'success');
            } catch (error) {
                showResult('sigResult', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('sigBtn', false);
            }
        }
    </script>
</body>
</html>
